{"title":"flutter_chat_system","slug":"flutter-chatSystem","date":"2019-08-06T12:56:38.000Z","updated":"2019-09-18T11:27:39.480Z","comments":true,"path":"api/articles/flutter-chatSystem.json","photos":[],"link":"","excerpt":null,"covers":["/2019/08/06/flutter-chatSystem/chatPage.gif","/2019/08/06/flutter-chatSystem/chatListPage.gif","/2019/08/06/flutter-chatSystem/chatPage.gif","/2019/08/06/flutter-chatSystem/sendMessage.gif"],"content":"<p>最近一直在学习<code>flutter</code>，所以还是有必要去做一些相关笔记的，<code>flutter</code>的生态有待完善，尤其是集成第三方SDK，目前大多数第三方包都是没有给flutter提供直接import集成方法的，但是好在flutter可以使用MethodChannel等方法来与底层进行通信，有助于我们更好的去集成，但是在此之前，你需要对flutter的dart和安卓的java以及Ios的Oc有一定的基础有一定的了解，<br>不然就只能像我这样，黑夜中抓瞎。不多说了，写个聊天的小demo，目前只是实现基础的布局，可以先看预览的一下效果。<br><img src=\"/2019/08/06/flutter-chatSystem/chatPage.gif\" alt></p>\n<p><strong>第一步 首先实现基础的列表以及路由的跳转</strong><br><img src=\"/2019/08/06/flutter-chatSystem/chatListPage.gif\" alt><br>关于布局，其实没什么可以说的了，这是最基本的布局。因为表单这一块还没有思路，并没有展示出来。<br>整个小demo是分了两个<code>.dart</code>文件的。<br><code>main.dart</code>入口函数</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &apos;package:flutter/material.dart&apos;;</span><br><span class=\"line\">import &apos;chatPage.dart&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">void main()=&gt; runApp(MyApp());</span><br><span class=\"line\"></span><br><span class=\"line\">class MyApp extends StatelessWidget &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  @override</span><br><span class=\"line\">  Widget build(BuildContext context) &#123;</span><br><span class=\"line\">    return MaterialApp(</span><br><span class=\"line\">      home: Scaffold(</span><br><span class=\"line\">        appBar: AppBar(</span><br><span class=\"line\">          title: Text(&quot;聊天室&quot;),</span><br><span class=\"line\">          centerTitle: true,</span><br><span class=\"line\"></span><br><span class=\"line\">        ),</span><br><span class=\"line\">        body: ChatList()</span><br><span class=\"line\">      ),</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class ChatList extends StatefulWidget &#123;</span><br><span class=\"line\">  @override</span><br><span class=\"line\">  _ChatListState createState() =&gt; _ChatListState();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class _ChatListState extends State&lt;ChatList&gt; &#123;</span><br><span class=\"line\">  final title = &quot;花开不败&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">  @override</span><br><span class=\"line\">  Widget build(BuildContext context) &#123;</span><br><span class=\"line\">    return ListView.builder(</span><br><span class=\"line\">          itemCount: messageData.length,</span><br><span class=\"line\">          itemBuilder: (BuildContext context , int index)&#123;</span><br><span class=\"line\">            return InkWell(</span><br><span class=\"line\">              child: MessageItem(messageData[index]),</span><br><span class=\"line\">              onTap: ()&#123;</span><br><span class=\"line\">                print(index);</span><br><span class=\"line\">                Navigator.push(context, MaterialPageRoute(builder: (context) =&gt; ChatPage(title)));</span><br><span class=\"line\">              &#125;,</span><br><span class=\"line\">            );</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">        );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//构造函数，这个函数应该具有：avatar ,nickName , title , chatContent, time 几个属性</span><br><span class=\"line\"> class MessageData&#123;</span><br><span class=\"line\">   String avatar;</span><br><span class=\"line\">   String title;</span><br><span class=\"line\">   String chatContent;</span><br><span class=\"line\">   String time;</span><br><span class=\"line\">   MessageData(this.avatar,this.title,this.chatContent,this.time);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">// 将上述函数存放入数组，</span><br><span class=\"line\">List&lt;MessageData&gt; messageData = [</span><br><span class=\"line\">  MessageData(&quot;image/avatar.ico&quot;, &quot;花开不败&quot;, &quot;哈哈哈，我是你的聊天内容&quot;, &quot;17:45&quot;)</span><br><span class=\"line\">];</span><br><span class=\"line\">// 聊天的布局</span><br><span class=\"line\">class MessageItem extends StatelessWidget &#123;</span><br><span class=\"line\"> </span><br><span class=\"line\">  final MessageData message ;</span><br><span class=\"line\">// MessageItem调用MessageData的内部属性，用来填充布局上的一些变量</span><br><span class=\"line\">  MessageItem(this.message);</span><br><span class=\"line\">  final titleStyle = TextStyle(color: Colors.black,fontWeight: FontWeight.bold,fontSize: 18.0);</span><br><span class=\"line\">  @override</span><br><span class=\"line\">  Widget build(BuildContext context) &#123;</span><br><span class=\"line\">    return  Container(</span><br><span class=\"line\">      margin: const EdgeInsets.all(5),</span><br><span class=\"line\">      decoration: BoxDecoration(</span><br><span class=\"line\">        // border: Border.all(color: Colors.black,width: 2)</span><br><span class=\"line\">      ),</span><br><span class=\"line\">      child: Row(</span><br><span class=\"line\">        children: &lt;Widget&gt;[</span><br><span class=\"line\">          Image.asset(message.avatar,width: 50,height: 50,),</span><br><span class=\"line\">          Container(</span><br><span class=\"line\">            margin: const EdgeInsets.fromLTRB(15, 5, 5, 5),</span><br><span class=\"line\">            child: Column(</span><br><span class=\"line\">              crossAxisAlignment: CrossAxisAlignment.start,</span><br><span class=\"line\">              children: &lt;Widget&gt;[</span><br><span class=\"line\">                Text(message.title,style: titleStyle,),</span><br><span class=\"line\">                Text(message.chatContent),</span><br><span class=\"line\">              ],</span><br><span class=\"line\">            ),</span><br><span class=\"line\">          ),</span><br><span class=\"line\">          Expanded(</span><br><span class=\"line\">            child: Container(</span><br><span class=\"line\">              margin: const EdgeInsets.fromLTRB(0, 0, 0, 20),</span><br><span class=\"line\">              decoration: BoxDecoration(</span><br><span class=\"line\">                // border: Border.all(color: Colors.red,width: 2.0)</span><br><span class=\"line\">              ),</span><br><span class=\"line\">              alignment: Alignment.topRight,</span><br><span class=\"line\">              child: Text(message.time),</span><br><span class=\"line\">            ),</span><br><span class=\"line\">          )</span><br><span class=\"line\">        ],</span><br><span class=\"line\">      ),</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>需要注意的是，关于列表这一块，不要盲目的去写，首先你应该知道，列表的数据一般都是服务端以一个对象的形式提供，对象内每一个数组都对应着每一个列表项，<br><code>flutter</code>也为我们提供了一个<code>ListView.builder</code>的构造方法，让我们去遍历每一个数组的数据，然后生成列表。当你在开发相关项目时，你会明显的看到控制台打印相关的数据信息，前提是你在<br>初始化了一些第三方即时通讯的SDK并拿到相关列表数据。</p>\n<h2 id=\"在这里记一下关于-flutter-中路由传参吧\"><a href=\"#在这里记一下关于-flutter-中路由传参吧\" class=\"headerlink\" title=\"在这里记一下关于 flutter 中路由传参吧.\"></a>在这里记一下关于 flutter 中<strong>路由传参</strong>吧.</h2><p>在flutter中，通常使用<code>Navigator.push(context, MaterialPageRoute(builder: (context) =&gt; newPage( 要传递的参数 )));</code>来进行参数的传递,<br>例如本篇demo中，假设我们需要将用户的title传到聊天页面中，我们可以使用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Navigator.push(</span><br><span class=\"line\">    context, </span><br><span class=\"line\">    MaterialPageRoute(</span><br><span class=\"line\">        builder: (context) =&gt; newPage( title //传递的title )</span><br><span class=\"line\">    )</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">//如果你只在这个页面写上title他下面是会出现红线报错的，因为在你要跳转的另一个页面内并没有发现title这个变量，就是没有去接受这个参数，</span><br><span class=\"line\">所以我们应该去第二个页面内 写一个构造函数用来接受这个参数</span><br><span class=\"line\">class ChatPage extends StatefulWidget &#123;</span><br><span class=\"line\">//在这里接受路由传过来的参数</span><br><span class=\"line\">  final String title;</span><br><span class=\"line\">  ChatPage(this.title);</span><br><span class=\"line\">  @override</span><br><span class=\"line\">  _ChatPageState createState() =&gt; _ChatPageState();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class _ChatPageState extends State&lt;ChatPage&gt; &#123;</span><br><span class=\"line\">  @override</span><br><span class=\"line\">  `````</span><br><span class=\"line\">另外当你需要使用的时候 ，你需要 用 widget.变量名 才能正确拿到值，如果传的参数是多个，同理，穿的时候参数用逗号分隔，接受的时候添加大括号，</span><br><span class=\"line\">一定要注意变量名需要正确匹配！</span><br></pre></td></tr></table></figure>\n\n<p><strong>第二步，实现连天页面的布局以及聊天记录</strong><br>然后到了关于聊天消息的页面，这边假设了一下聊天消息，和user识别，以及对应user的头像。先看一下效果图吧。<br><img src=\"/2019/08/06/flutter-chatSystem/chatPage.gif\" alt></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &apos;package:flutter/material.dart&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">class ChatPage extends StatefulWidget &#123;</span><br><span class=\"line\">  final String title;</span><br><span class=\"line\">  ChatPage(this.title);</span><br><span class=\"line\">  @override</span><br><span class=\"line\">  _ChatPageState createState() =&gt; _ChatPageState();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class _ChatPageState extends State&lt;ChatPage&gt; &#123;</span><br><span class=\"line\">  @override</span><br><span class=\"line\">  Widget build(BuildContext context) &#123;</span><br><span class=\"line\">    return Scaffold(</span><br><span class=\"line\">      appBar: AppBar(</span><br><span class=\"line\">        title: Text(widget.title),</span><br><span class=\"line\">        centerTitle: true,</span><br><span class=\"line\">        leading: IconButton(</span><br><span class=\"line\">          icon: Icon(Icons.arrow_left),</span><br><span class=\"line\">          onPressed: ()&#123;</span><br><span class=\"line\">            Navigator.pop(context);</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">        ),</span><br><span class=\"line\">      ),</span><br><span class=\"line\">      body: ListView(</span><br><span class=\"line\">        children: &lt;Widget&gt;[</span><br><span class=\"line\">          ListView(</span><br><span class=\"line\">            shrinkWrap: true,</span><br><span class=\"line\">            physics: new NeverScrollableScrollPhysics(),</span><br><span class=\"line\">            children: &lt;Widget&gt;[</span><br><span class=\"line\">              chatMessageItem(&quot;image/avatar.ico&quot;,&quot;hai，你好啊&quot;,0),</span><br><span class=\"line\">              chatMessageItem(&quot;image/demo2.jpg&quot;,&quot;嗯嗯，你好呀&quot;,1),</span><br><span class=\"line\">              chatMessageItem(&quot;image/avatar.ico&quot;,&quot;嗯嗯，你好呀&quot;,0),</span><br><span class=\"line\">              chatMessageItem(&quot;image/demo2.jpg&quot;,&quot;嗯嗯，你好呀&quot;,1),</span><br><span class=\"line\">              chatMessageItem(&quot;image/avatar.ico&quot;,&quot;嗯嗯，你好呀&quot;,0),</span><br><span class=\"line\">              chatMessageItem(&quot;image/demo2.jpg&quot;,&quot;嗯嗯，你好呀&quot;,1),</span><br><span class=\"line\">              chatMessageItem(&quot;image/avatar.ico&quot;,&quot;嗯嗯，你好呀&quot;,0),</span><br><span class=\"line\">              chatMessageItem(&quot;image/demo2.jpg&quot;,&quot;咱也不敢说咱也不敢问咱也不敢说咱也不敢问咱也不敢说咱也不敢问咱也不敢说咱也不敢问&quot;,1),</span><br><span class=\"line\">              chatMessageItem(&quot;image/avatar.ico&quot;,&quot;嗯嗯，你好呀&quot;,0),</span><br><span class=\"line\">              chatMessageItem(&quot;image/demo2.jpg&quot;,&quot;哈哈哈 恭喜你也看到了我得消息&quot;,1),</span><br><span class=\"line\">                //这些都是伪数据 ，当你真实调用的时候，每条消息都会包含许多信息，conversation:&#123;...&#125;</span><br><span class=\"line\">            ],</span><br><span class=\"line\">          )</span><br><span class=\"line\">        ],</span><br><span class=\"line\">      ),</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  Widget chatMessageItem(String avatar , String message , int user)&#123;</span><br><span class=\"line\">    return Container(</span><br><span class=\"line\">      margin: EdgeInsets.symmetric(horizontal: 10,vertical:10),</span><br><span class=\"line\">      child:Row(</span><br><span class=\"line\">        mainAxisAlignment: user == 0 ? MainAxisAlignment.start: MainAxisAlignment.end,</span><br><span class=\"line\">        children: &lt;Widget&gt;[</span><br><span class=\"line\">          Container(</span><br><span class=\"line\">              child:user == 0 ?  CircleAvatar(</span><br><span class=\"line\">                backgroundImage: AssetImage(user == 0 ? avatar : &quot;&quot;),</span><br><span class=\"line\">              ):null</span><br><span class=\"line\"></span><br><span class=\"line\">          ),</span><br><span class=\"line\">          Container(</span><br><span class=\"line\">              margin: EdgeInsets.only(left: 10,right: 10),</span><br><span class=\"line\">              width: MediaQuery.of(context).size.width/2,</span><br><span class=\"line\">              decoration: BoxDecoration(</span><br><span class=\"line\">                color: Colors.yellow,</span><br><span class=\"line\">                borderRadius: BorderRadius.only(</span><br><span class=\"line\">                    topLeft: Radius.circular(user == 0 ? 15 : 5),</span><br><span class=\"line\">                    topRight: Radius.circular(user == 1 ? 15 : 5),</span><br><span class=\"line\">                    bottomLeft: Radius.circular(5),</span><br><span class=\"line\">                    bottomRight: Radius.circular(5)</span><br><span class=\"line\">                ),</span><br><span class=\"line\">              ),</span><br><span class=\"line\">              child: Padding(</span><br><span class=\"line\">                child: Text(message,style: TextStyle(color: Colors.black,fontSize: 15),softWrap: true,maxLines: 50,),</span><br><span class=\"line\">                padding: EdgeInsets.symmetric(horizontal: 10,vertical: 10),</span><br><span class=\"line\">              )</span><br><span class=\"line\">          ),</span><br><span class=\"line\">          Container(</span><br><span class=\"line\">            child:user == 1 ?  CircleAvatar(</span><br><span class=\"line\">              backgroundImage: AssetImage(user == 1 ? avatar : &quot;&quot;),</span><br><span class=\"line\">            ):null</span><br><span class=\"line\">          )</span><br><span class=\"line\">        ],</span><br><span class=\"line\">      ),</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在这里 ，我们整体的布局建议采用 外层Column嵌套ListView的布局来实现 ，内部ListView用于实现聊天记录的滚动，外层用来保证下面将要写的表单不被键盘弹出框遮住。如果你使用ListView嵌套listview的话 可能会有一些布局显示不出来的小问题 ，解决方案是在外层Listview内添加如下内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shrinkWrap: true, //内容适配</span><br><span class=\"line\">physics: new NeverScrollableScrollPhysics(),// 禁止滚动</span><br></pre></td></tr></table></figure>\n\n<p>我们将每一个对话定义为conversation，这个conversation里面包含消息发送者的资料，以及消息文本 ，将这些数据放在一个数组内，由ListView.builder构造函数将每一条渲染出来，</p>\n<p>聊天页面最重要的便是提供用户输入内容的表单了。</p>\n<hr>\n<p><strong>第三步  完善表单</strong><br>继续更 ，现在完成了表单的输入以及消息内容的发送，老规矩 ，先上图：<br><img src=\"/2019/08/06/flutter-chatSystem/sendMessage.gif\" alt></p>\n<p><strong>整理了一下代码的结构</strong></p>\n<p>chatPage:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &apos;package:flutter/material.dart&apos;;</span><br><span class=\"line\">import &apos;dart:io&apos;;</span><br><span class=\"line\">import &apos;dart:ui&apos;;</span><br><span class=\"line\">class ChatPage extends StatefulWidget &#123;</span><br><span class=\"line\">  final String title;</span><br><span class=\"line\">  ChatPage(this.title);</span><br><span class=\"line\">  @override</span><br><span class=\"line\">  _ChatPageState createState() =&gt; _ChatPageState();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class _ChatPageState extends State&lt;ChatPage&gt; &#123;</span><br><span class=\"line\">  TextEditingController _message = new TextEditingController();</span><br><span class=\"line\">  FocusNode focusNode = new FocusNode();</span><br><span class=\"line\">  bool isSend = false ;</span><br><span class=\"line\">  @override</span><br><span class=\"line\">  Widget build(BuildContext context) &#123;</span><br><span class=\"line\">    return Scaffold(</span><br><span class=\"line\">      appBar: AppBar(</span><br><span class=\"line\">        title: Text(widget.title),</span><br><span class=\"line\">        centerTitle: true,</span><br><span class=\"line\">        leading: IconButton(</span><br><span class=\"line\">          icon: Icon(Icons.arrow_left),</span><br><span class=\"line\">          onPressed: ()&#123;</span><br><span class=\"line\">            Navigator.pop(context);</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">        ),</span><br><span class=\"line\">      ),</span><br><span class=\"line\">      body: new Column(</span><br><span class=\"line\">        children: &lt;Widget&gt;[</span><br><span class=\"line\">          Container(</span><br><span class=\"line\">            child:new Flexible(</span><br><span class=\"line\">              child:  InkWell(</span><br><span class=\"line\">                child: ListView.builder(</span><br><span class=\"line\">                  itemCount: conversations.length,</span><br><span class=\"line\">                  itemBuilder: (BuildContext , int index )&#123;</span><br><span class=\"line\">                    return ConversationItem(conversations[index]);</span><br><span class=\"line\">                  &#125;,</span><br><span class=\"line\">                ),</span><br><span class=\"line\">                onTap: ()&#123;</span><br><span class=\"line\">// 点击聊天记录空白处，将表单的焦点，即让弹出的键盘框收回去。</span><br><span class=\"line\">                  focusNode.unfocus();</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">              )</span><br><span class=\"line\">            )</span><br><span class=\"line\">          ),</span><br><span class=\"line\">          Container(</span><br><span class=\"line\">            padding: const EdgeInsets.symmetric(vertical: 5),</span><br><span class=\"line\">            child: Row(</span><br><span class=\"line\">              children: &lt;Widget&gt;[</span><br><span class=\"line\">                Container(</span><br><span class=\"line\">                  margin:const EdgeInsets.symmetric(horizontal: 10),</span><br><span class=\"line\">                  child: Image.asset(&quot;image/voice.png&quot;,width: 30,height: 30,),</span><br><span class=\"line\">                ),</span><br><span class=\"line\">                Expanded(</span><br><span class=\"line\">                  child: Container(</span><br><span class=\"line\">                    child: TextField(</span><br><span class=\"line\">                      autofocus: true,</span><br><span class=\"line\">                      focusNode: focusNode,</span><br><span class=\"line\">                      style: TextStyle(fontSize: 18,color: Colors.black),</span><br><span class=\"line\">                      controller: _message,</span><br><span class=\"line\">                      decoration: InputDecoration(</span><br><span class=\"line\">                        border: OutlineInputBorder(),</span><br><span class=\"line\">                        contentPadding: EdgeInsets.symmetric(horizontal: 10,vertical: 10),</span><br><span class=\"line\">                        fillColor: Colors.white</span><br><span class=\"line\">                      ),</span><br><span class=\"line\">                      onChanged: (val)&#123;</span><br><span class=\"line\">//                        print(_message.text);</span><br><span class=\"line\">                        if(_message.text == &quot;&quot;)&#123;</span><br><span class=\"line\">                          setState(() &#123;</span><br><span class=\"line\">                            isSend = false ;</span><br><span class=\"line\">                          &#125;);</span><br><span class=\"line\">                        &#125;else if(_message.text != null )&#123;</span><br><span class=\"line\">                          setState(() &#123;</span><br><span class=\"line\">                            isSend = true ;</span><br><span class=\"line\">                          &#125;);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                      &#125;,</span><br><span class=\"line\">                    ),</span><br><span class=\"line\">                  ),</span><br><span class=\"line\">                ),</span><br><span class=\"line\">              Container(</span><br><span class=\"line\">                  margin:const EdgeInsets.symmetric(horizontal: 10),</span><br><span class=\"line\">                  child: isSend == false ? Image.asset(&quot;image/add.png&quot;,width: 30,height: 30,) : InkWell(</span><br><span class=\"line\">                    child: Image.asset(&quot;image/send.png&quot;,width: 30,height: 30,),</span><br><span class=\"line\">                    onTap: ()&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">// 点击发送时，我们将存放conversation的数组新增一条消息记录，默认头像是自己的头像 ，用户点击发送后，将表单内的文本内容添加到conversation里面，</span><br><span class=\"line\">并初始化表单为 “” 。</span><br><span class=\"line\">                      setState(() &#123;</span><br><span class=\"line\">                        conversations.add(Conversation(&quot;image/demo2.jpg&quot;, _message.text, 1));</span><br><span class=\"line\">                      &#125;);</span><br><span class=\"line\">                      _message.clear();</span><br><span class=\"line\">                      _message.text == &quot;&quot;;</span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                  ),</span><br><span class=\"line\">              )</span><br><span class=\"line\">              ],</span><br><span class=\"line\">            ),</span><br><span class=\"line\">          )</span><br><span class=\"line\">        ],</span><br><span class=\"line\">      ),</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class Conversation &#123;</span><br><span class=\"line\">  String avatar ;</span><br><span class=\"line\">  String text ;</span><br><span class=\"line\">  int user ;</span><br><span class=\"line\">  Conversation(this.avatar,this.text,this.user,);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">List&lt;Conversation&gt; conversations =[</span><br><span class=\"line\">  Conversation(&quot;image/avatar.ico&quot;,&quot;hai，你好啊&quot;,0),</span><br><span class=\"line\">  Conversation(&quot;image/demo2.jpg&quot;,&quot;嗯嗯，你好呀&quot;,1),</span><br><span class=\"line\">  Conversation(&quot;image/avatar.ico&quot;,&quot;嗯嗯，你好呀&quot;,0),</span><br><span class=\"line\">  Conversation(&quot;image/demo2.jpg&quot;,&quot;嗯嗯，你好呀&quot;,1),</span><br><span class=\"line\">  Conversation(&quot;image/avatar.ico&quot;,&quot;嗯嗯，你好呀&quot;,0),</span><br><span class=\"line\">  Conversation(&quot;image/demo2.jpg&quot;,&quot;嗯嗯，你好呀&quot;,1),</span><br><span class=\"line\">  Conversation(&quot;image/avatar.ico&quot;,&quot;嗯嗯，你好呀&quot;,0),</span><br><span class=\"line\">  Conversation(&quot;image/demo2.jpg&quot;,&quot;咱也不敢说咱也不敢问咱也不敢说咱也不敢问咱也不敢说咱也不敢问咱也不敢说咱也不敢问&quot;,1),</span><br><span class=\"line\">  Conversation(&quot;image/avatar.ico&quot;,&quot;嗯嗯，你好呀&quot;,0),</span><br><span class=\"line\">  Conversation(&quot;image/demo2.jpg&quot;,&quot;哈哈哈 恭喜你也看到了我得消息&quot;,1),</span><br><span class=\"line\">];</span><br><span class=\"line\"></span><br><span class=\"line\">class ConversationItem extends StatelessWidget &#123;</span><br><span class=\"line\">  final Conversation conversation ;</span><br><span class=\"line\">  ConversationItem(this.conversation);</span><br><span class=\"line\">  @override</span><br><span class=\"line\">  Widget build(BuildContext context) &#123;</span><br><span class=\"line\">    return Container(</span><br><span class=\"line\">      margin: EdgeInsets.symmetric(horizontal: 10,vertical:10),</span><br><span class=\"line\">      child:Row(</span><br><span class=\"line\">        mainAxisAlignment: conversation.user == 0 ? MainAxisAlignment.start: MainAxisAlignment.end,</span><br><span class=\"line\">        children: &lt;Widget&gt;[</span><br><span class=\"line\">          Container(</span><br><span class=\"line\">              child:conversation.user == 0 ?  CircleAvatar(</span><br><span class=\"line\">                backgroundImage: AssetImage(conversation.user == 0 ? conversation.avatar : &quot;&quot;),</span><br><span class=\"line\">              ):null</span><br><span class=\"line\"></span><br><span class=\"line\">          ),</span><br><span class=\"line\">          Container(</span><br><span class=\"line\">              margin: EdgeInsets.only(left: 10,right: 10),</span><br><span class=\"line\">              width: MediaQuery.of(context).size.width/2,</span><br><span class=\"line\">              decoration: BoxDecoration(</span><br><span class=\"line\">//                        border: Border.all(color: Colors.red,width: 1),</span><br><span class=\"line\">                color: conversation.user == 0 ? Colors.white : Colors.green,</span><br><span class=\"line\">                borderRadius: BorderRadius.only(</span><br><span class=\"line\">                    topLeft: Radius.circular(conversation.user == 0 ? 15 : 5),</span><br><span class=\"line\">                    topRight: Radius.circular(conversation.user == 1 ? 15 : 5),</span><br><span class=\"line\">                    bottomLeft: Radius.circular(5),</span><br><span class=\"line\">                    bottomRight: Radius.circular(5)</span><br><span class=\"line\">                ),</span><br><span class=\"line\">              ),</span><br><span class=\"line\">              child: Padding(</span><br><span class=\"line\">                child: Text(conversation.text,style: TextStyle(color: Colors.black,fontSize: 15),softWrap: true,maxLines: 50,),</span><br><span class=\"line\">                padding: EdgeInsets.symmetric(horizontal: 10,vertical: 10),</span><br><span class=\"line\">              )</span><br><span class=\"line\">          ),</span><br><span class=\"line\">          Container(</span><br><span class=\"line\">              child:conversation.user == 1 ?  CircleAvatar(</span><br><span class=\"line\">                backgroundImage: AssetImage(conversation.user == 1 ? conversation.avatar : &quot;&quot;),</span><br><span class=\"line\">              ):null</span><br><span class=\"line\">          )</span><br><span class=\"line\">        ],</span><br><span class=\"line\">      ),</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":[],"tags":[{"name":"-Flutter","slug":"Flutter","count":5,"path":"api/tags/Flutter.json"}]}